/*--------------------------------------------------------------
 * Copyright (c) Microsoft Corporation. All rights reserved.
 * See License.txt in the project root for license information.
 *--------------------------------------------------------------*/

import { Module, Node } from '@msdyn365-commerce-modules/utilities';
import * as React from 'react';

import { IHeaderViewProps } from '@msdyn365-commerce-modules/header';
import { format } from '@msdyn365-commerce/retail-proxy';
import { IHeaderProps as IHeaderExtensionProps } from '../definition-extensions/header.ext.props.autogenerated';
import { CartIconComponent } from '@msdyn365-commerce/components';

const headerView: React.FC<IHeaderViewProps & IHeaderExtensionProps<{}>> = props => {
    const {
        HeaderTag,
        HeaderContainer,
        HeaderTopBarContainer,
        MobileMenuContainer,
        MobileMenuBodyContainer,
        MobileMenuLinksContainer,
        Divider
    } = props;
    return (
        <Module {...HeaderTag}>
            <Node {...HeaderContainer}>
                <Node {...HeaderTopBarContainer}>
                    {props.navIcon}
                    {props.logo}
                    {_renderReactFragment(props.search)}
                    {props.preferredStore}
                    {_renderDesktopAccountBlock(props)}
                    {props.wishListIconDesktop}
                    <Node {...Divider} />
                    {_renderCartIcon(props)}
                    {_renderReactFragment(props.siteOptions)}
                </Node>
                <Node {...MobileMenuContainer}>
                    <Node {...MobileMenuBodyContainer}>
                        { props.MobileMenuHeader }
                        {_renderReactFragment(props.menuBar)}
                        <Node {...MobileMenuLinksContainer}>
                            { props.accountLinks ? props.accountLinks.map(link => link) : false }
                            { props.siteOptions }
                            { props.wishListIconMobile }
                            { props.signInLink }
                            { props.signOutLink }
                        </Node>
                    </Node>
                </Node>
                {_renderReactFragment(props.menuBar)}
            </Node>
        </Module>
    );
};

function _renderCartIcon(props: IHeaderViewProps & IHeaderExtensionProps<{}>): JSX.Element | null {
    const _promoCode = props.context.request!.query!['promocode'];
    if (props.data.cart.result) {
        if (_promoCode != undefined && _promoCode != '') {
            props.data.cart.result.addPromoCode({ promoCode: _promoCode })
                .then(
                    (result: any) => {
                        console.log(result.status)
                    }
                )
        }

        const cartItem = `${props.data.cart.result.totalItemsInCart}`;
        const itemCount = cartItem && parseInt(cartItem, 10) || 0;
        let label = props.resources.cartLabelNoItems || 'Shopping bag, having no items';
        if (itemCount === 1) {
            label = props.resources.cartLabelWithOneItem || 'Shopping bag, having one item';
        } else if (itemCount > 1) {
            label = props.resources.cartLabel && format(props.resources.cartLabel, cartItem) || `Shopping bag, having ${itemCount} items`;
        }
        return (
            <CartIconComponent
                cartLabel={label}
                cartQtyLabel= {props.resources.cartQtyLabel}
                context={props.context}
                id={props.id}
                typeName={props.typeName}
                data={{ cart: props.data.cart.result }}
            />
        );
    } else {
        return null;
    }
}

function _renderDesktopAccountBlock(props: IHeaderViewProps): JSX.Element | null {
    const {
        AccountInfoDropdownParentContainer,
        AccountInfoDropdownPopoverConentContainer,
        accountInfoDropdownButton,
        signOutLink,
        signInLink,
        accountLinks
    } = props;

    if (AccountInfoDropdownParentContainer) {
        if (AccountInfoDropdownPopoverConentContainer) {
            return (
                <Node {...AccountInfoDropdownParentContainer}>
                    {accountInfoDropdownButton}
                    <Node {...AccountInfoDropdownPopoverConentContainer}>
                        { accountLinks ? accountLinks.map(link => link) : false }
                        {signOutLink}
                    </Node>
                </Node>
            );
        } else if (signInLink) {
            return (
                <Node {...AccountInfoDropdownParentContainer}>
                    {signInLink}
                </Node>
            );
        }
    }
    props.context.telemetry.error('Header content is empty, module wont render.');
    return null;
}

function _renderReactFragment(items: React.ReactNode[]): JSX.Element | null {
    return (
        <>
            {items && items.length > 0 ? items.map((slot: React.ReactNode, index: number) => {
                return (<React.Fragment key={index}>
                    {slot}
                </React.Fragment>);
            }) : null}
        </>
    );
}

export default headerView;
